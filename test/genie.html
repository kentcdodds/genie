<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Genie unit tests</title>
    <script src="../genie.js"></script>
    <script src="evidence.js"></script>
  </head>
  <body>
    <h1>Genie unit tests</h1>
    <p>
      Your wish is my command...<br />
      See the browser console for results.
    </p>
    <p>
      See the <a href="https://github.com/kentcdodds/genie">project on GitHub</a> for more info.
    </p>
    <p>
      Click <a href="../">here</a> to see a demo.
    </p>
    
    <script>
      function prepForTest() {
        genie.clearWishes();
      }
      
      function registerBlankWish(magicWords) {
        return genie(magicWords,function (){});
      }
      
      Evidence.TestCase.extend('GenieTest', {
        testWishRegistration: function(t) {
          prepForTest();
          var wishCalled = 0;
          var wish = genie('wish', function() {
            wishCalled++;
          });
          t.assertEqual(wishCalled, 0);
          
          genie.makeWish(wish);
          t.assertEqual(wishCalled, 1);
          
          genie.deregisterWish(wish);
          genie.makeWish(wish);
          t.assertEqual(wishCalled, 1);
          
          // Test registration with object.
          var wish2 = genie({
            id: 'wish2',
            data: {
              display: 'Zerahemla',
              image: 'file/somewhere/image.png'
            },
            magicWords: ['Zerahemla', 'Nephite City'],
            action: function(wish2Object) {
              t.assertIdentical(wish2Object, wish2);
            }
          });
          genie.makeWish(wish2);
        },
        testClearingWishes: function(t) {
          prepForTest();
          var wishCalled = 0;
          var wish = genie('wish', function() {
            wishCalled++;
          });
          genie.clearWishes();
          genie.makeWish(wish);
          t.assertEqual(wishCalled, 0);
        },
        testMagicWords: function(t) {
          prepForTest();
          registerBlankWish('Lord of the Flies');
          registerBlankWish('Pirates of the Carribean');
          registerBlankWish('Lord of the Rings');
          
          var ofTheWishes = genie.getMatchingWishes('of the');
          t.assertEqual(ofTheWishes.length, 3);
          
          var lordWishes = genie.getMatchingWishes('Lord of the');
          t.assertEqual(lordWishes.length, 2);
          
          var ringWishes = genie.getMatchingWishes('Ring');
          t.assertEqual(ringWishes.length, 1);
        },
        testMultipleMagicWords: function(t) {
          prepForTest();
          registerBlankWish(['Book', 'Music', 'Movie']);
          registerBlankWish(['Cat', 'Dog', 'Goat']);
          
          var bookWish = genie.getMatchingWishes('b');
          var mWish = genie.getMatchingWishes('m');
          var movieWish = genie.getMatchingWishes('movie');
          t.assertEqual(bookWish.length, 1);
          t.assertEqual(mWish.length, 1);
          t.assertEqual(movieWish.length, 1);
          t.assertIdentical(bookWish[0], mWish[0]);
          t.assertIdentical(mWish[0], movieWish[0]);


          var catWish = genie.getMatchingWishes('cat');
          var dWish = genie.getMatchingWishes('d');
          var tWish = genie.getMatchingWishes('t');
          t.assertEqual(catWish.length, 1);
          t.assertEqual(dWish.length, 1);
          t.assertEqual(tWish.length, 1);
          t.assertIdentical(catWish[0], dWish[0]);
          t.assertIdentical(dWish[0], tWish[0]);
          
          var oWishes = genie.getMatchingWishes('o');
          t.assertEqual(oWishes.length, 2);
          t.assertFalse(oWishes[0] === oWishes[1]);
        },
        testSimpleEnteredMagicWords: function(t) {
          prepForTest();
          var fredCall = 0;
          var ethelCall = 0;
          var lucyCall = 0;
          
          var fred = genie('Fred Mertz', function() {
            fredCall++;
          });
          var ethel = genie('Ethel Mertz', function() {
            ethelCall++;
          });
          var lucy = genie('Lucy Mertz', function() {
            lucyCall++;
          });
          
          // In order of their registration
          var mertzMatch = genie.getMatchingWishes('mertz');
          t.assertIdentical(mertzMatch[0], fred);
          t.assertIdentical(mertzMatch[1], ethel);
          t.assertIdentical(mertzMatch[2], lucy);
          
          // In order of called then registration
          genie.makeWish(ethel, 'mertz');
          mertzMatch = genie.getMatchingWishes('mertz');
          t.assertIdentical(mertzMatch[0], ethel);
          t.assertIdentical(mertzMatch[1], fred);
          t.assertIdentical(mertzMatch[2], lucy);

          /*
           * More complicated here. A specific wish must be called
           * twice in a row for a specific magic word for it to
           * be first if that magic word already has a wish
           * associated with it. So lucy must be called with
           * 'mertz' twice in a row before she can take the
           * top spot.
           */
          genie.makeWish(lucy, 'mertz');
          mertzMatch = genie.getMatchingWishes('mertz');
          t.assertIdentical(mertzMatch[0], ethel);
          t.assertIdentical(mertzMatch[1], lucy);
          t.assertIdentical(mertzMatch[2], fred);
          
          /*
           * Lucy is now king of the hill.
           * Ethel is second, and fred isn't
           * even on the hill at all...
           */
          genie.makeWish(lucy, 'mertz');
          mertzMatch = genie.getMatchingWishes('mertz');
          t.assertIdentical(mertzMatch[0], lucy);
          t.assertIdentical(mertzMatch[1], ethel);
          t.assertIdentical(mertzMatch[2], fred);
          
          /*
           * De-registering lucy and making a
           * wish with fred will place ethel as
           * king of the hill and fred as second
           */
          genie.deregisterWish(lucy);
          genie.makeWish(fred, 'mertz');
          mertzMatch = genie.getMatchingWishes('mertz');
          t.assertEqual(mertzMatch.length, 2);
          t.assertIdentical(mertzMatch[0], ethel);
          t.assertIdentical(mertzMatch[1], fred);
        },
        testComplexMagicWords: function(t) {
          prepForTest();
          var ttofc = registerBlankWish('The Tail of Forty Cities');
          var ttotc = registerBlankWish('The Tail of Two Cities');
          var ttotcAcronym = 'ttotc';
          
          // Even though ttofc was registered first, acronym trumps match
          var match = genie.getMatchingWishes(ttotcAcronym);
          t.assertEqual(match.length, 2);
          t.assertIdentical(match[0], ttotc);
          t.assertIdentical(match[1], ttofc);
          
          // enteredMagicWords trumps acronym
          genie.makeWish(ttofc, ttotcAcronym);
          var match = genie.getMatchingWishes(ttotcAcronym);
          t.assertEqual(match.length, 2);
          t.assertIdentical(match[0], ttofc);
          t.assertIdentical(match[1], ttotc);
        }
      });
    </script>
  </body>
</html>
